<%- include('./partials/header', { title: 'Chat - ChatApp' }) %>

<div class="h-full flex flex-col md:flex-row overflow-hidden">
  <!-- Sidebar / Contact List -->
  <div class="w-full md:w-80 lg:w-96 bg-white shadow-md flex flex-col overflow-hidden border-r border-gray-200">
    <div class="p-4 bg-white border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800">
        <i class="fas fa-users me-2 text-primary"></i>Contacts
      </h2>
      <div class="mt-2 relative">
        <input type="text" id="contact-search" placeholder="Rechercher un contact..." class="form-input py-2 pl-9 pr-4 text-sm" autocomplete="off">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>
    </div>
    
    <div class="flex-1 overflow-y-auto contacts-container">
      <% if (contacts && contacts.length > 0) { %>
        <div class="divide-y divide-gray-100">
          <% contacts.forEach(contact => { %>
            <a 
              href="/chat/<%= contact.id %>" 
              class="contact-item block p-3 transition-colors <%= selectedContact && selectedContact.id === contact.id ? 'active' : '' %>"
              data-user-id="<%= contact.id %>"
            >
              <div class="flex items-center">
                <div class="relative">
                  <div class="relative w-12 h-12 rounded-full overflow-hidden bg-gray-200">
                    <img 
                      src="<%= contact.avatar ? `/uploads/${contact.avatar}` : '/img/default-avatar.svg' %>" 
                      alt="<%= contact.username %>"
                      class="w-full h-full object-cover"
                      onerror="this.src='/img/default-avatar.svg'"
                    >
                  </div>
                </div>
                <div class="ml-3 flex-1">
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-800"><%= contact.username %></span>
                    <% if (contact.unreadCount > 0) { %>
                      <span class="unread-badge inline-flex items-center justify-center w-5 h-5 text-xs font-bold leading-none text-white rounded-full"><%= contact.unreadCount %></span>
                    <% } else { %>
                      <span class="unread-badge hidden inline-flex items-center justify-center w-5 h-5 text-xs font-bold leading-none text-white rounded-full">0</span>
                    <% } %>
                  </div>
                  <p class="text-sm text-gray-500 truncate">
                    <% if (contact.is_online) { %>
                      <i class="fas fa-circle text-green-500 text-xs mr-1"></i> En ligne
                    <% } else { %>
                      <i class="fas fa-clock text-gray-400 text-xs mr-1"></i> Vu: <%= new Date(contact.last_seen).toLocaleString() %>
                    <% } %>
                  </p>
                </div>
              </div>
            </a>
          <% }) %>
        </div>
      <% } else { %>
        <div class="p-8 text-center">
          <div class="text-gray-400 mb-4">
            <i class="fas fa-user-friends text-4xl"></i>
          </div>
          <h3 class="text-gray-500 font-medium mb-2">Aucun contact disponible</h3>
          <p class="text-gray-400 text-sm">Vos contacts apparaîtront ici une fois que vous aurez commencé à communiquer avec d'autres utilisateurs.</p>
        </div>
      <% } %>
    </div>
  </div>
  
  <!-- Chat Area -->
  <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
    <% if (selectedContact) { %>
      <!-- Contact Header -->
      <div class="p-4 bg-white shadow-sm border-b border-gray-200 flex justify-between items-center">
        <div class="flex items-center">
          <div class="relative">
            <div class="relative w-10 h-10 rounded-full overflow-hidden bg-gray-200">
              <img 
                src="<%= selectedContact.avatar ? `/uploads/${selectedContact.avatar}` : '/img/default-avatar.svg' %>" 
                alt="<%= selectedContact.username %>"
                class="w-full h-full object-cover"
                onerror="this.src='/img/default-avatar.svg'"
              >
            </div>
            <span class="status-indicator absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full <%= selectedContact.is_online ? 'bg-green-500' : 'bg-gray-400' %>"></span>
          </div>
          <div class="ml-3">
            <h3 class="font-medium text-gray-800"><%= selectedContact.username %></h3>
            <p class="text-xs text-gray-500">
              <% if (selectedContact.is_online) { %>
                En ligne
              <% } else { %>
                Vu: <%= new Date(selectedContact.last_seen).toLocaleString() %>
              <% } %>
            </p>
          </div>
        </div>
        
        <div class="flex items-center space-x-2">
          <% if (selectedContact.isBlocked) { %>
            <form action="/chat/<%= selectedContact.id %>/unblock" method="POST" class="inline">
              <button id="unblock-user" type="submit" class="flex items-center px-3 py-1 text-sm bg-green-50 text-green-600 hover:bg-green-100 rounded-full transition-colors">
                <i class="fas fa-unlock mr-1"></i> Débloquer
              </button>
            </form>
          <% } else { %>
            <form action="/chat/<%= selectedContact.id %>/block" method="POST" class="inline">
              <button id="block-user" type="submit" class="flex items-center px-3 py-1 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded-full transition-colors">
                <i class="fas fa-ban mr-1"></i> Bloquer
              </button>
            </form>
          <% } %>
        </div>
      </div>
      
      <!-- Messages Container -->
      <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4">
        <% if (messages && messages.length > 0) { %>
          <% messages.forEach(message => { %>
            <div class="chat-message <%= message.sender_id == user.id ? 'chat-message-mine' : 'chat-message-others' %>">
              <% if (message.message_type === 'text') { %>
                <%= message.content %>
              <% } else if (message.message_type === 'file') { %>
                <% if (message.file_url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) { %>
                  <div class="message-image-container">
                    <img src="<%= message.file_url %>" alt="Image" class="message-image rounded-lg max-w-xs max-h-64 object-cover cursor-pointer" onclick="openImagePreview('<%= message.file_url %>')">
                  </div>
                <% } else { %>
                  <a href="<%= message.file_url %>" target="_blank" class="flex items-center space-x-1">
                    <i class="fas fa-file-download mr-1"></i>
                    <span><%= message.content %></span>
                  </a>
                <% } %>
              <% } %>
              <div class="text-xs mt-1 text-gray-400 flex justify-between">
                <%= new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %>
                <% if (message.sender_id == user.id) { %>
                  <span class="read-indicator <%= message.is_read ? '' : 'hidden' %>">
                    <i class="fas fa-check-double text-blue-500"></i>
                  </span>
                <% } %>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="flex flex-col items-center justify-center h-full">
            <div class="bg-white p-5 rounded-xl shadow-sm text-center">
              <div class="text-primary mb-3">
                <i class="fas fa-comment-alt text-4xl opacity-50"></i>
              </div>
              <h3 class="text-gray-700 font-medium mb-2">Pas encore de messages</h3>
              <p class="text-gray-500 text-sm">Envoyez un message pour démarrer la conversation!</p>
            </div>
          </div>
        <% } %>
        
        <!-- Typing indicator -->
        <div id="typing-indicator" class="chat-message chat-message-others hidden">
          <div class="flex space-x-1 ml-1">
            <div class="typing-dot bg-gray-400 rounded-full h-2 w-2 animate-bounce"></div>
            <div class="typing-dot bg-gray-400 rounded-full h-2 w-2 animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="typing-dot bg-gray-400 rounded-full h-2 w-2 animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
        </div>
      </div>
      
      <!-- Message Form -->
      <div class="p-4 bg-white border-t border-gray-200">
        <% if (!selectedContact.isBlocked) { %>
          <form id="message-form" class="flex items-center space-x-3">
            <button type="button" id="emoji-picker-btn" class="text-gray-500 hover:text-gray-700 transition-colors">
              <i class="far fa-smile text-xl"></i>
            </button>
            
            <div class="relative flex-1">
              <input 
                type="text" 
                id="message-input" 
                placeholder="Tapez votre message..." 
                class="form-input py-2"
                autocomplete="off"
              >
              <div id="emoji-picker" class="hidden absolute bottom-full left-0 mb-4 -top-[300px] bg-white rounded-lg shadow-lg border border-gray-200 w-[320px] z-10">
                <!-- Onglets des catégories -->
                <div class="border-b border-gray-200">
                  <div class="flex p-2 gap-2">
                    <button type="button" class="emoji-category-btn active p-2 hover:bg-gray-100 rounded" data-category="recent">
                      <i class="fas fa-clock"></i>
                    </button>
                    <button type="button" class="emoji-category-btn p-2 hover:bg-gray-100 rounded" data-category="smileys">
                      <i class="far fa-smile"></i>
                    </button>
                    <button type="button" class="emoji-category-btn p-2 hover:bg-gray-100 rounded" data-category="gestures">
                      <i class="far fa-hand-peace"></i>
                    </button>
                    <button type="button" class="emoji-category-btn p-2 hover:bg-gray-100 rounded" data-category="love">
                      <i class="far fa-heart"></i>
                    </button>
                    <button type="button" class="emoji-category-btn p-2 hover:bg-gray-100 rounded" data-category="nature">
                      <i class="fas fa-leaf"></i>
                    </button>
                    <button type="button" class="emoji-category-btn p-2 hover:bg-gray-100 rounded" data-category="food">
                      <i class="fas fa-utensils"></i>
                    </button>
                    <button type="button" class="emoji-category-btn p-2 hover:bg-gray-100 rounded" data-category="activities">
                      <i class="fas fa-futbol"></i>
                    </button>
                  </div>
                </div>

                <!-- Conteneur des emojis -->
                <div class="p-2 h-[280px] overflow-y-auto">
                  <!-- Récents -->
                  <div class="emoji-category" data-category="recent">
                    <div class="grid grid-cols-8 gap-1 w-[304px]" style="height: 280px;">
                      <% const recentEmojis = ['😀', '❤️', '👍', '🙏', '👋', '😊', '🎉', '🔥', '💯', '✨', '🌟', '💪', '🙌', '👏', '💖', '😍', '🥰', '😘', '🤗', '😌', '😎', '🤓', '😅', '😂', '🤣', '😆', '😄', '😁', '😉', '😋', '😛', '😝', '😜', '🤪', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯', '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵']; %>
                      <% recentEmojis.forEach(emoji => { %>
                        <button type="button" class="emoji w-8 h-8 text-xl hover:bg-gray-100 rounded transition-colors flex items-center justify-center" title="<%= emoji %>"><%= emoji %></button>
                      <% }); %>
                    </div>
                  </div>

                  <!-- Smileys -->
                  <div class="emoji-category hidden" data-category="smileys">
                    <div class="grid grid-cols-8 gap-1 w-[304px]" style="height: 280px;">
                      <% const smileys = ['😀', '😃', '😄', '😁', '😅', '😂', '🤣', '😊', '😇', '🙂', '🙃', '😉', '😌', '😍', '🥰', '😘', '😗', '😙', '😚', '😋', '😛', '😝', '😜', '🤪', '🤨', '🧐', '🤓', '😎', '🤩', '🥳', '😏', '😒', '😞', '😔', '😟', '😕', '🙁', '☹️', '😣', '😖', '😫', '😩', '🥺', '😢', '😭', '😤', '😠', '😡', '🤬', '🤯', '😳', '🥵', '🥶', '😱', '😨', '😰', '😥', '😓', '🤗', '🤔', '🤭', '🤫', '🤥', '😶', '😐', '😑', '😬', '🙄', '😯', '😦', '😧', '😮', '😲', '🥱', '😴', '🤤', '😪', '😵']; %>
                      <% smileys.forEach(emoji => { %>
                        <button type="button" class="emoji w-8 h-8 text-xl hover:bg-gray-100 rounded transition-colors flex items-center justify-center" title="<%= emoji %>"><%= emoji %></button>
                      <% }); %>
                    </div>
                  </div>

                  <!-- Gestes -->
                  <div class="emoji-category hidden" data-category="gestures">
                    <div class="grid grid-cols-8 gap-1 w-[304px]" style="height: 280px;">
                      <% const gestures = ['👋', '🤚', '✋', '🖐️', '👌', '🤌', '🤏', '✌️', '🤞', '🤟', '🤘', '🤙', '👈', '👉', '👆', '🖕', '👇', '☝️', '👍', '👎', '✊', '👊', '🤛', '🤜', '👏', '🙌', '👐', '🤲', '🤝', '🙏', '💪', '🦾', '🖐️', '✋', '🤚', '👋']; %>
                      <% gestures.forEach(emoji => { %>
                        <button type="button" class="emoji w-8 h-8 text-xl hover:bg-gray-100 rounded transition-colors flex items-center justify-center" title="<%= emoji %>"><%= emoji %></button>
                      <% }); %>
                    </div>
                  </div>

                  <!-- Amour -->
                  <div class="emoji-category hidden" data-category="love">
                    <div class="grid grid-cols-8 gap-1 w-[304px]" style="height: 280px;">
                      <% const love = ['❤️', '🧡', '💛', '💚', '💙', '💜', '🤎', '🖤', '🤍', '💔', '❤️‍🔥', '❤️‍🩹', '❣️', '💕', '💞', '💓', '💗', '💖', '💘', '💝', '💟', '♥️', '😍', '🥰', '😘', '😻', '💑', '💏', '👫', '👭', '👬']; %>
                      <% love.forEach(emoji => { %>
                        <button type="button" class="emoji w-8 h-8 text-xl hover:bg-gray-100 rounded transition-colors flex items-center justify-center" title="<%= emoji %>"><%= emoji %></button>
                      <% }); %>
                    </div>
                  </div>

                  <!-- Nature -->
                  <div class="emoji-category hidden" data-category="nature">
                    <div class="grid grid-cols-8 gap-1 w-[304px]" style="height: 280px;">
                      <% const nature = ['🌸', '🌷', '🌹', '🌺', '🌻', '🌼', '🌾', '🌿', '☘️', '🍀', '🍁', '🍂', '🍃', '🌍', '🌎', '🌏', '🌑', '🌒', '🌓', '🌔', '🌕', '🌖', '🌗', '🌘', '🌙', '🌚', '🌛', '🌜', '☀️', '🌝', '🌞', '⭐', '🌟', '🌠', '☁️', '⛅', '⛈️', '🌤️', '🌥️', '🌦️', '🌧️', '🌨️', '🌩️', '🌪️', '🌫️', '🌈', '☂️', '⚡', '❄️', '☃️', '⛄', '☄️', '💧', '🌊']; %>
                      <% nature.forEach(emoji => { %>
                        <button type="button" class="emoji w-8 h-8 text-xl hover:bg-gray-100 rounded transition-colors flex items-center justify-center" title="<%= emoji %>"><%= emoji %></button>
                      <% }); %>
                    </div>
                  </div>

                  <!-- Nourriture -->
                  <div class="emoji-category hidden" data-category="food">
                    <div class="grid grid-cols-8 gap-1 w-[304px]" style="height: 280px;">
                      <% const food = ['🍏', '🍎', '🍐', '🍊', '🍋', '🍌', '🍉', '🍇', '🍓', '🫐', '🍈', '🍒', '🍑', '🥭', '🍍', '🥥', '🥝', '🍅', '🍆', '🥑', '🥦', '🥬', '🥒', '🌶️', '🫑', '🌽', '🥕', '🫒', '🧄', '🧅', '🥔', '🍠', '🥐', '🥯', '🍞', '🥖', '🥨', '🧀', '🥚', '🍳', '🧈', '🥞', '🧇', '🥓', '🥩', '🍗', '🍖', '🦴', '🌭', '🍔', '🍟', '🍕', '🫓', '🥪', '🥙', '🧆', '🌮', '🌯', '🫔', '🥗', '🥘', '🫕', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍱', '🥟', '🦪', '🍤', '🍙', '🍚', '🍘', '🍥', '🥠', '🥮', '🍢', '🍡', '🍧', '🍨', '🍦', '🥧', '🧁', '🍰', '🎂', '🍮', '🍭', '🍬', '🍫', '🍿', '🍩', '🍪', '🌰', '🥜', '🍯', '🥛', '🍼', '☕', '🫖', '🍵', '🧃', '🥤', '🧋', '🍶', '🍺', '🍻', '🥂', '🍷', '🥃', '🍸', '🍹', '🧉', '🍾', '🧊', '🥄', '🍴', '🍽️', '🥢', '🥡']; %>
                      <% food.forEach(emoji => { %>
                        <button type="button" class="emoji w-8 h-8 text-xl hover:bg-gray-100 rounded transition-colors flex items-center justify-center" title="<%= emoji %>"><%= emoji %></button>
                      <% }); %>
                    </div>
                  </div>

                  <!-- Activités -->
                  <div class="emoji-category hidden" data-category="activities">
                    <div class="grid grid-cols-8 gap-1 w-[304px]" style="height: 280px;">
                      <% const activities = ['⚽', '🏀', '🏈', '⚾', '🥎', '🎾', '🏐', '🏉', '🥏', '🎱', '🪀', '🏓', '🏸', '🏒', '🏑', '🥍', '🏏', '🪃', '🥅', '⛳', '🪁', '🎣', '🤿', '🎽', '🎿', '🛷', '🥌', '🎯', '🪀', '🪁', '🎱', '🎮', '🎲', '🧩', '🎨', '🎭', '🎪', '🎤', '🎧', '🎼', '🎹', '🥁', '🎷', '🎺', '🎸', '🪕', '🎻', '🎲', '♟️', '🎯', '🎳', '🎮', '🎰', '🧩']; %>
                      <% activities.forEach(emoji => { %>
                        <button type="button" class="emoji w-8 h-8 text-xl hover:bg-gray-100 rounded transition-colors flex items-center justify-center" title="<%= emoji %>"><%= emoji %></button>
                      <% }); %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- File upload button -->
            <div class="relative">
              <button type="button" class="cursor-pointer text-gray-500 hover:text-primary transition-colors" onclick="document.getElementById('file-upload').click();">
                <i class="fas fa-paperclip text-xl"></i>
              </button>
            </div>
            
            <!-- File preview area -->
            <div id="file-preview" class="hidden flex items-center">
              <div class="relative mr-2">
                <img id="file-preview-image" src="" alt="Aperçu" class="w-10 h-10 object-cover rounded">
                <button type="button" onclick="removeFilePreview()" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
            <button type="submit">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>

          <!-- File upload form (outside message form) -->
          <form id="file-upload-form" action="/chat/<%= selectedContact.id %>/upload" method="POST" enctype="multipart/form-data" class="hidden">
            <input id="file-upload" name="file" type="file" class="hidden" accept="image/*,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,text/plain">
          </form>

          <!-- File upload confirmation modal -->
          <div id="file-upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4 shadow-xl">
              <div class="flex items-center mb-4">
                <i class="fas fa-file-upload text-primary text-2xl mr-3"></i>
                <h3 class="text-lg font-semibold">Confirmation d'envoi</h3>
              </div>
              <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <p class="text-sm text-gray-600 mb-2">Vous êtes sur le point d'envoyer :</p>
                <p id="selected-file-name" class="text-gray-800 font-medium break-all"></p>
              </div>
              <div class="flex justify-end space-x-3">
                <button type="button" onclick="cancelFileUpload()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded transition-colors">
                  <i class="fas fa-times mr-2"></i>Annuler
                </button>
                <button type="button" onclick="confirmFileUpload()" class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded transition-colors">
                  <i class="fas fa-check mr-2"></i>Confirmer l'envoi
                </button>
              </div>
            </div>
          </div>

          <!-- Image preview modal -->
          <div id="image-preview-modal" class="hidden fixed inset-0 z-[9999] bg-black bg-opacity-90">
            <div class="absolute inset-0 flex items-center justify-center">
              <button onclick="closeImagePreview()" class="absolute top-4 right-4 text-white hover:text-gray-300 transition-colors">
                <i class="fas fa-times text-2xl"></i>
              </button>
              <img id="preview-full-image" src="" alt="Image en plein écran" class="max-w-[90vw] max-h-[90vh] object-contain rounded-lg">
            </div>
          </div>
        <% } else { %>
          <div class="text-center text-red-500 font-medium p-3 bg-red-50 rounded-lg">
            <i class="fas fa-ban mr-2"></i>
            Vous avez bloqué cet utilisateur. Débloquez-le pour envoyer des messages.
          </div>
        <% } %>
      </div>
    <% } else { %>
      <div class="flex-1 flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-sm text-center max-w-md animate-fade-in">
          <div class="text-gray-400 mb-4 bg-gray-50 p-6 inline-block rounded-full">
            <i class="fas fa-comments text-5xl text-primary opacity-60"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">Bienvenue sur ChatApp</h3>
          <p class="text-gray-500 mb-6">
            Sélectionnez un contact dans la liste pour commencer à discuter. Notre plateforme vous permet de communiquer en temps réel avec tous vos contacts professionnels.
          </p>
          <div class="flex flex-wrap justify-center gap-4 text-sm">
            <div class="flex items-center">
              <i class="fas fa-lock text-primary mr-2"></i>
              <span>Conversations sécurisées</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-bolt text-primary mr-2"></i>
              <span>Messagerie en temps réel</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-file-upload text-primary mr-2"></i>
              <span>Partage de fichiers</span>
            </div>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>

<script src="/js/chat.js"></script>
<script src="/js/emoji-picker.js"></script>
</div> 