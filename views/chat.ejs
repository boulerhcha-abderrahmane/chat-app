<%- include('./partials/header', { title: 'Chat - ChatApp' }) %>

<div class="h-full flex flex-col md:flex-row overflow-hidden">
  <!-- Sidebar / Contact List -->
  <div class="w-full md:w-80 lg:w-96 bg-white shadow-md flex flex-col overflow-hidden border-r border-gray-200">
    <div class="p-4 bg-white border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-800">
        <i class="fas fa-users me-2 text-primary"></i>Contacts
      </h2>
      <div class="mt-2 relative">
        <input type="text" id="contact-search" placeholder="Rechercher un contact..." class="form-input py-2 pl-9 pr-4 text-sm" autocomplete="off">
        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      </div>
    </div>
    
    <div class="flex-1 overflow-y-auto contacts-container">
      <% if (contacts && contacts.length > 0) { %>
        <div class="divide-y divide-gray-100">
          <% contacts.forEach(contact => { %>
            <a 
              href="/chat/<%= contact.id %>" 
              class="contact-item block p-3 transition-colors <%= selectedContact && selectedContact.id === contact.id ? 'active' : '' %>"
              data-user-id="<%= contact.id %>"
            >
              <div class="flex items-center">
                <div class="relative">
                  <div class="relative w-12 h-12 rounded-full overflow-hidden bg-gray-200">
                    <img 
                      src="<%= contact.avatar ? `/uploads/${contact.avatar}` : '/img/default-avatar.png' %>" 
                      alt="<%= contact.username %>"
                      class="w-full h-full object-cover"
                      onerror="this.src='/img/default-avatar.png'"
                    >
                  </div>
                  <span class="status-indicator absolute bottom-0 right-0 w-3 h-3 rounded-full <%= contact.is_online ? 'bg-green-500' : 'bg-gray-400' %>"></span>
                </div>
                <div class="ml-3 flex-1">
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-gray-800"><%= contact.username %></span>
                    <% if (contact.unreadCount > 0) { %>
                      <span class="unread-badge inline-flex items-center justify-center w-5 h-5 text-xs font-bold leading-none text-white rounded-full"><%= contact.unreadCount %></span>
                    <% } else { %>
                      <span class="unread-badge hidden inline-flex items-center justify-center w-5 h-5 text-xs font-bold leading-none text-white rounded-full">0</span>
                    <% } %>
                  </div>
                  <p class="text-sm text-gray-500 truncate">
                    <% if (contact.is_online) { %>
                      <i class="fas fa-circle text-green-500 text-xs mr-1"></i> En ligne
                    <% } else { %>
                      <i class="fas fa-clock text-gray-400 text-xs mr-1"></i> Vu: <%= new Date(contact.last_seen).toLocaleString() %>
                    <% } %>
                  </p>
                </div>
              </div>
            </a>
          <% }) %>
        </div>
      <% } else { %>
        <div class="p-8 text-center">
          <div class="text-gray-400 mb-4">
            <i class="fas fa-user-friends text-4xl"></i>
          </div>
          <h3 class="text-gray-500 font-medium mb-2">Aucun contact disponible</h3>
          <p class="text-gray-400 text-sm">Vos contacts appara√Ætront ici une fois que vous aurez commenc√© √† communiquer avec d'autres utilisateurs.</p>
        </div>
      <% } %>
    </div>
  </div>
  
  <!-- Chat Area -->
  <div class="flex-1 flex flex-col bg-gray-50 overflow-hidden">
    <% if (selectedContact) { %>
      <!-- Contact Header -->
      <div class="p-4 bg-white shadow-sm border-b border-gray-200 flex justify-between items-center">
        <div class="flex items-center">
          <div class="relative">
            <div class="relative w-10 h-10 rounded-full overflow-hidden bg-gray-200">
              <img 
                src="<%= selectedContact.avatar ? `/uploads/${selectedContact.avatar}` : '/img/default-avatar.png' %>" 
                alt="<%= selectedContact.username %>"
                class="w-full h-full object-cover"
                onerror="this.src='/img/default-avatar.png'"
              >
            </div>
            <span class="status-indicator absolute bottom-0 right-0 w-2.5 h-2.5 rounded-full <%= selectedContact.is_online ? 'bg-green-500' : 'bg-gray-400' %>"></span>
          </div>
          <div class="ml-3">
            <h3 class="font-medium text-gray-800"><%= selectedContact.username %></h3>
            <p class="text-xs text-gray-500">
              <% if (selectedContact.is_online) { %>
                <i class="fas fa-circle text-green-500 text-xs mr-1"></i> En ligne
              <% } else { %>
                <i class="fas fa-clock text-gray-400 text-xs mr-1"></i> Vu: <%= new Date(selectedContact.last_seen).toLocaleString() %>
              <% } %>
            </p>
          </div>
        </div>
        
        <div class="flex items-center space-x-2">
          <% if (selectedContact.isBlocked) { %>
            <form action="/chat/<%= selectedContact.id %>/unblock" method="POST" class="inline">
              <button id="unblock-user" type="submit" class="flex items-center px-3 py-1 text-sm bg-green-50 text-green-600 hover:bg-green-100 rounded-full transition-colors">
                <i class="fas fa-unlock mr-1"></i> D√©bloquer
              </button>
            </form>
          <% } else { %>
            <form action="/chat/<%= selectedContact.id %>/block" method="POST" class="inline">
              <button id="block-user" type="submit" class="flex items-center px-3 py-1 text-sm bg-red-50 text-red-600 hover:bg-red-100 rounded-full transition-colors">
                <i class="fas fa-ban mr-1"></i> Bloquer
              </button>
            </form>
          <% } %>
        </div>
      </div>
      
      <!-- Messages Container -->
      <div id="messages-container" class="flex-1 p-4 overflow-y-auto space-y-4">
        <% if (messages && messages.length > 0) { %>
          <% messages.forEach(message => { %>
            <div class="chat-message <%= message.sender_id == user.id ? 'chat-message-mine' : 'chat-message-others' %>">
              <% if (message.message_type === 'text') { %>
                <%= message.content %>
              <% } else if (message.message_type === 'file') { %>
                <a href="<%= message.file_url %>" target="_blank" class="flex items-center space-x-1">
                  <i class="fas fa-file-download mr-1"></i>
                  <span><%= message.content %></span>
                </a>
              <% } %>
              <div class="text-xs mt-1 text-gray-400 flex justify-between">
                <%= new Date(message.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) %>
                <% if (message.sender_id == user.id) { %>
                  <span class="read-indicator <%= message.is_read ? '' : 'hidden' %>">
                    <i class="fas fa-check-double text-blue-500"></i>
                  </span>
                <% } %>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="flex flex-col items-center justify-center h-full">
            <div class="bg-white p-5 rounded-xl shadow-sm text-center">
              <div class="text-primary mb-3">
                <i class="fas fa-comment-alt text-4xl opacity-50"></i>
              </div>
              <h3 class="text-gray-700 font-medium mb-2">Pas encore de messages</h3>
              <p class="text-gray-500 text-sm">Envoyez un message pour d√©marrer la conversation!</p>
            </div>
          </div>
        <% } %>
        
        <!-- Typing indicator -->
        <div id="typing-indicator" class="chat-message chat-message-others hidden">
          <div class="flex space-x-1 ml-1">
            <div class="typing-dot bg-gray-400 rounded-full h-2 w-2 animate-bounce"></div>
            <div class="typing-dot bg-gray-400 rounded-full h-2 w-2 animate-bounce" style="animation-delay: 0.2s"></div>
            <div class="typing-dot bg-gray-400 rounded-full h-2 w-2 animate-bounce" style="animation-delay: 0.4s"></div>
          </div>
        </div>
      </div>
      
      <!-- Message Form -->
      <div class="p-4 bg-white border-t border-gray-200">
        <% if (!selectedContact.isBlocked) { %>
          <form id="message-form" class="flex items-center space-x-3">
            <button type="button" id="emoji-picker-btn" class="text-gray-500 hover:text-gray-700 transition-colors">
              <i class="far fa-smile text-xl"></i>
            </button>
            
            <div class="relative flex-1">
              <input 
                type="text" 
                id="message-input" 
                placeholder="Tapez votre message..." 
                class="form-input py-2"
                autocomplete="off"
              >
              <div id="emoji-picker" class="hidden absolute bottom-full left-0 mb-2 p-2 bg-white rounded-lg shadow-lg border border-gray-200 grid grid-cols-8 gap-1 w-64 z-10">
                <% const emojis = ['üòÄ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ']; %>
                <% emojis.forEach(emoji => { %>
                  <button type="button" class="emoji w-6 h-6 text-lg hover:bg-gray-100 rounded transition-colors"><%= emoji %></button>
                <% }) %>
              </div>
            </div>
            
            <!-- File upload -->
            <div class="relative">
              <form id="file-upload-form" action="/chat/<%= selectedContact.id %>/upload" method="POST" enctype="multipart/form-data" class="inline">
                <label for="file-upload" class="cursor-pointer text-gray-500 hover:text-primary transition-colors">
                  <i class="fas fa-paperclip text-xl"></i>
                </label>
                <input id="file-upload" name="file" type="file" class="hidden">
              </form>
            </div>
            
            <button type="submit">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        <% } else { %>
          <div class="text-center text-red-500 font-medium p-3 bg-red-50 rounded-lg">
            <i class="fas fa-ban mr-2"></i>
            Vous avez bloqu√© cet utilisateur. D√©bloquez-le pour envoyer des messages.
          </div>
        <% } %>
      </div>
    <% } else { %>
      <div class="flex-1 flex flex-col items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-sm text-center max-w-md animate-fade-in">
          <div class="text-gray-400 mb-4 bg-gray-50 p-6 inline-block rounded-full">
            <i class="fas fa-comments text-5xl text-primary opacity-60"></i>
          </div>
          <h3 class="text-xl font-semibold text-gray-700 mb-2">Bienvenue sur ChatApp</h3>
          <p class="text-gray-500 mb-6">
            S√©lectionnez un contact dans la liste pour commencer √† discuter. Notre plateforme vous permet de communiquer en temps r√©el avec tous vos contacts professionnels.
          </p>
          <div class="flex flex-wrap justify-center gap-4 text-sm">
            <div class="flex items-center">
              <i class="fas fa-lock text-primary mr-2"></i>
              <span>Conversations s√©curis√©es</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-bolt text-primary mr-2"></i>
              <span>Messagerie en temps r√©el</span>
            </div>
            <div class="flex items-center">
              <i class="fas fa-file-upload text-primary mr-2"></i>
              <span>Partage de fichiers</span>
            </div>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>

<script src="/js/chat.js"></script>

<%- include('./partials/footer') %> 